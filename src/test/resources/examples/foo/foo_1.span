# NAME: Threshold Mix Protocol
# PARAMETERS: 2 parties, 1 round

.metadata

    version : 1.0;
    recipe depth : 3;

.constants

    fraction p : 1/2;

.signature

    sort : PKey, SKey, Nonce, Message, Vote, Host;
    subsort : PKey, SKey, Nonce, Vote < Message;

    variables : m, msg1, msg2 | Message;
    variables : r, k | Nonce;
    variables : y1, y2, y3, y4, y5, y6 | Message;

    variables : z1, z2, z3, z4 | Message;
    variables : h1, h2 | Host;
    variables : v1, v2 | Vote;
    variables : n1, n2, n3 | Nonce;
    variables : skey1 | Skey;

    function : pk | Nonce -> PKey;
    function : sk | Nonce -> SKey;
    function : commit | Message Nonce -> Message;
    function : open | Message Nonce -> Message;
    function : sign | Message SKey -> Message;
    function : checksign | Message PKey -> Message;
    function : blind | Message Nonce -> Message;
    function : unblind | Message Nonce -> Message;
    function : host | PKey -> Host;
    function : getpk | Host -> PKey;
    function : pair | Message Message -> Message;
    function : fst | Message -> Message;
    function : snd | Message -> Message;

    public names : a | Message;

    private names : m1 | Message;
    private names : r1, b1, k1 | Nonce;
    private names : a, l, s | Nonce;
    private names : party1 | Vote;

.rewrites

    rewrite : getpk(host(pk(k))) -> pk(k);
    rewrite : open(commit(m,r),r) -> m;
    rewrite : checksign(sign(m, sk(k)), pk(k)) -> m;
    rewrite : unblind(blind(m,r),r) -> m;
    rewrite : unblind(sign(blind(m,r), sk(k)), r) -> sign(m, sk(k));
    rewrite : fst(pair(msg1, msg2)) -> msg1;
    rewrite : snd(pair(msg1, msg2)) -> msg2;

.roles

    role :  {0} [T] out(1 -> pk(a));
    role :  {0} [T] out(1 -> pk(k1));

    role :  {1} [T] out(1 -> pair( host(pk(k1)), sign(blind(commit(party1, r1),b1), sk(k1))) ) .
            {1} in(y1{}) .
            {2} [ checksign(y1, pk(a)) == blind(commit(party1, r1),b1) ] out( 1 -> unblind(y1, b1) ) .
            {2} in(y2{pair(z1, sign(z2,sk(a)))}) .
            {3} [snd(y2) ==  sign( commit(party1, r1) , sk(a)) ] out(1 -> pair(fst(y2), r1));

    role :  {1} in(y3{pair(h1, sign(z4, sk(k1)))}) .
            {1} [ pk(k1) == getpk(fst(y3)) ] out(1 -> sign(checksign(snd(y3), pk(k1)), sk(a)));

    role :  {2} in(y4{sign(z4, sk(a))}) .
            {2} [T] out(1 -> pair(l, y4)) .
            {3} in(y5{pair(l, z3)}) .
            {3} [T] out(1-> open(checksign(y4, pk(a)), snd(y5)));

    role :  {4} in(y6{party1}) .
            {4} [ y6 == party1 ] out(1 -> s);

.safety
    secrecy : s >= 1;